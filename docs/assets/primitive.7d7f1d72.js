import{_ as le}from"./OperateBox.2bc9a4e9.js";import{u as se,f as ce,a as de,o as ue,c as re,w as T,d as j,e as N}from"./index.f76e180b.js";import{E as ae}from"./el-button.55669a7a.js";import{g as Z}from"./api.42f836e8.js";import{D as he}from"./dialog.23bf7777.js";import"./request.3e4b99dc.js";function W(e,i,t,n,o,c){if(o-n<=t)return;const s=n+o>>1;ee(e,i,s,n,o,c%2),W(e,i,t,n,s-1,c+1),W(e,i,t,s+1,o,c+1)}function ee(e,i,t,n,o,c){for(;o>n;){if(o-n>600){const r=o-n+1,_=t-n+1,p=Math.log(r),b=.5*Math.exp(2*p/3),g=.5*Math.sqrt(p*b*(r-b)/r)*(_-r/2<0?-1:1),C=Math.max(n,Math.floor(t-_*b/r+g)),I=Math.min(o,Math.floor(t+(r-_)*b/r+g));ee(e,i,t,C,I,c)}const s=i[2*t+c];let l=n,u=o;for(z(e,i,n,t),i[2*o+c]>s&&z(e,i,n,o);l<u;){for(z(e,i,l,u),l++,u--;i[2*l+c]<s;)l++;for(;i[2*u+c]>s;)u--}i[2*n+c]===s?z(e,i,n,u):(u++,z(e,i,u,o)),u<=t&&(n=u+1),t<=u&&(o=u-1)}}function z(e,i,t,n){G(e,t,n),G(i,2*t,2*n),G(i,2*t+1,2*n+1)}function G(e,i,t){const n=e[i];e[i]=e[t],e[t]=n}function fe(e,i,t,n,o,c,s){const l=[0,e.length-1,0],u=[];let r,_;for(;l.length;){const p=l.pop(),b=l.pop(),g=l.pop();if(b-g<=s){for(let x=g;x<=b;x++)r=i[2*x],_=i[2*x+1],r>=t&&r<=o&&_>=n&&_<=c&&u.push(e[x]);continue}const C=Math.floor((g+b)/2);r=i[2*C],_=i[2*C+1],r>=t&&r<=o&&_>=n&&_<=c&&u.push(e[C]);const I=(p+1)%2;(p===0?t<=r:n<=_)&&(l.push(g),l.push(C-1),l.push(I)),(p===0?o>=r:c>=_)&&(l.push(C+1),l.push(b),l.push(I))}return u}function _e(e,i,t,n,o,c){const s=[0,e.length-1,0],l=[],u=o*o;for(;s.length;){const r=s.pop(),_=s.pop(),p=s.pop();if(_-p<=c){for(let x=p;x<=_;x++)Q(i[2*x],i[2*x+1],t,n)<=u&&l.push(e[x]);continue}const b=Math.floor((p+_)/2),g=i[2*b],C=i[2*b+1];Q(g,C,t,n)<=u&&l.push(e[b]);const I=(r+1)%2;(r===0?t-o<=g:n-o<=C)&&(s.push(p),s.push(b-1),s.push(I)),(r===0?t+o>=g:n+o>=C)&&(s.push(b+1),s.push(_),s.push(I))}return l}function Q(e,i,t,n){const o=e-t,c=i-n;return o*o+c*c}const me=e=>e[0],be=e=>e[1];class Ce{constructor(i,t=me,n=be,o=64,c=Float64Array){this.nodeSize=o,this.points=i;const s=i.length<65536?Uint16Array:Uint32Array,l=this.ids=new s(i.length),u=this.coords=new c(i.length*2);for(let r=0;r<i.length;r++)l[r]=r,u[2*r]=t(i[r]),u[2*r+1]=n(i[r]);W(l,u,o,0,l.length-1,0)}range(i,t,n,o){return fe(this.ids,this.coords,i,t,n,o,this.nodeSize)}within(i,t,n){return _e(this.ids,this.coords,i,t,n,this.nodeSize)}}function L(e){e=Cesium.defaultValue(e,Cesium.defaultValue.EMPTY_OBJECT),this._enabled=Cesium.defaultValue(e.enabled,!1),this._pixelRange=Cesium.defaultValue(e.pixelRange,80),this._minimumClusterSize=Cesium.defaultValue(e.minimumClusterSize,2),this._clusterBillboards=Cesium.defaultValue(e.clusterBillboards,!0),this._clusterLabels=Cesium.defaultValue(e.clusterLabels,!0),this._clusterPoints=Cesium.defaultValue(e.clusterPoints,!0),this._labelCollection=void 0,this._billboardCollection=void 0,this._pointCollection=void 0,this._clusterBillboardCollection=void 0,this._clusterLabelCollection=void 0,this._clusterPointCollection=void 0,this._collectionIndicesByEntity={},this._unusedLabelIndices=[],this._unusedBillboardIndices=[],this._unusedPointIndices=[],this._previousClusters=[],this._previousHeight=void 0,this._enabledDirty=!1,this._clusterDirty=!1,this._cluster=void 0,this._removeEventListener=void 0,this._clusterEvent=new Cesium.Event,this.show=Cesium.defaultValue(e.show,!0)}function pe(e){return e.coord.x}function ge(e){return e.coord.y}function X(e,i){e.x-=i,e.y-=i,e.width+=i*2,e.height+=i*2}const Be=new Cesium.BoundingRectangle;function $(e,i,t,n,o){if(Cesium.defined(e._labelCollection)&&n._clusterLabels?o=Cesium.Label.getScreenSpaceBoundingBox(e,i,o):Cesium.defined(e._billboardCollection)&&n._clusterBillboards?o=Cesium.Billboard.getScreenSpaceBoundingBox(e,i,o):Cesium.defined(e._pointPrimitiveCollection)&&n._clusterPoints&&(o=Cesium.PointPrimitive.getScreenSpaceBoundingBox(e,i,o)),X(o,t),n._clusterLabels&&!Cesium.defined(e._labelCollection)&&Cesium.defined(e.id)&&ie(n,e.id.id)&&Cesium.defined(e.id._label)){const c=n._collectionIndicesByEntity[e.id.id].labelIndex,s=n._labelCollection.get(c),l=Cesium.Label.getScreenSpaceBoundingBox(s,i,Be);X(l,t),o=Cesium.BoundingRectangle.union(o,l,o)}return o}function xe(e,i){if(e.clusterShow=!0,!Cesium.defined(e._labelCollection)&&Cesium.defined(e.id)&&ie(i,e.id.id)&&Cesium.defined(e.id._label)){const t=i._collectionIndicesByEntity[e.id.id].labelIndex,n=i._labelCollection.get(t);n.clusterShow=!0}}function q(e,i,t,n){const o={billboard:n._clusterBillboardCollection.add(),label:n._clusterLabelCollection.add(),point:n._clusterPointCollection.add()};o.billboard.show=!1,o.point.show=!1,o.label.show=!0,o.label.text=i.toLocaleString(),o.label.id=t,o.billboard.position=o.label.position=o.point.position=e,n._clusterEvent.raiseEvent(t,o)}function ie(e,i){return Cesium.defined(e)&&Cesium.defined(e._collectionIndicesByEntity[i])&&Cesium.defined(e._collectionIndicesByEntity[i].labelIndex)}function K(e,i,t,n,o){if(!Cesium.defined(e))return;const c=e.length;for(let s=0;s<c;++s){const l=e.get(s);if(l.clusterShow=!1,!l.show||o._scene.mode===Cesium.SceneMode.SCENE3D&&!n.isPointVisible(l.position))continue;const u=l.computeScreenSpacePosition(t);!Cesium.defined(u)||i.push({index:s,collection:e,clustered:!1,coord:u})}}const we=new Cesium.BoundingRectangle,Ie=new Cesium.BoundingRectangle,ve=new Cesium.BoundingRectangle;function Le(e){return function(i){if(Cesium.defined(i)&&i<.05||!e.enabled)return;const t=e._scene,n=e._labelCollection,o=e._billboardCollection,c=e._pointCollection;if(!Cesium.defined(n)&&!Cesium.defined(o)&&!Cesium.defined(c)||!e._clusterBillboards&&!e._clusterLabels&&!e._clusterPoints)return;let s=e._clusterLabelCollection,l=e._clusterBillboardCollection,u=e._clusterPointCollection;Cesium.defined(s)?s.removeAll():s=e._clusterLabelCollection=new Cesium.LabelCollection({scene:t}),Cesium.defined(l)?l.removeAll():l=e._clusterBillboardCollection=new Cesium.BillboardCollection({scene:t}),Cesium.defined(u)?u.removeAll():u=e._clusterPointCollection=new Cesium.PointPrimitiveCollection;const r=e._pixelRange,_=e._minimumClusterSize,p=e._previousClusters,b=[],g=e._previousHeight,C=t.camera.positionCartographic.height,I=t.mapProjection.ellipsoid,x=t.camera.positionWC,A=new Cesium.EllipsoidalOccluder(I,x),a=[];e._clusterLabels&&K(n,a,t,A,e),e._clusterBillboards&&K(o,a,t,A,e),e._clusterPoints&&K(c,a,t,A,e);let f,d,m,h,w,P,M,E,V,D,H,O;const J=new Ce(a,pe,ge,64,Int32Array);if(C<g)for(m=p.length,f=0;f<m;++f){const B=p[f];if(!A.isPointVisible(B.position))continue;const y=Cesium.Billboard._computeScreenSpacePosition(Cesium.Matrix4.IDENTITY,B.position,Cesium.Cartesian3.ZERO,Cesium.Cartesian2.ZERO,t);if(!Cesium.defined(y))continue;const R=1-C/g;let S=B.width=B.width*R,v=B.height=B.height*R;S=Math.max(S,B.minimumWidth),v=Math.max(v,B.minimumHeight);const k=y.x-S*.5,te=y.y-v*.5,ne=y.x+S,oe=y.y+v;for(w=J.range(k,te,ne,oe),P=w.length,D=0,V=[],d=0;d<P;++d)M=w[d],E=a[M],E.clustered||(++D,H=E.collection,O=E.index,V.push(H.get(O).id));if(D>=_)for(q(B.position,D,V,e),b.push(B),d=0;d<P;++d)a[w[d]].clustered=!0}for(m=a.length,f=0;f<m;++f){const B=a[f];if(B.clustered)continue;B.clustered=!0,H=B.collection,O=B.index;const y=H.get(O);h=$(y,B.coord,r,e,we);const R=Cesium.BoundingRectangle.clone(h,Ie);w=J.range(h.x,h.y,h.x+h.width,h.y+h.height),P=w.length;const S=Cesium.Cartesian3.clone(y.position);for(D=1,V=[y.id],d=0;d<P;++d)if(M=w[d],E=a[M],!E.clustered){const v=E.collection.get(E.index),k=$(v,E.coord,r,e,ve);Cesium.Cartesian3.add(v.position,S,S),Cesium.BoundingRectangle.union(R,k,R),++D,V.push(v.id)}if(D>=_){const v=Cesium.Cartesian3.multiplyByScalar(S,1/D,S);for(q(v,D,V,e),b.push({position:v,width:R.width,height:R.height,minimumWidth:h.width,minimumHeight:h.height}),d=0;d<P;++d)a[w[d]].clustered=!0}else xe(y,e)}s.length===0&&(s.destroy(),e._clusterLabelCollection=void 0),l.length===0&&(l.destroy(),e._clusterBillboardCollection=void 0),u.length===0&&(u.destroy(),e._clusterPointCollection=void 0),e._previousClusters=b,e._previousHeight=C}}L.prototype._initialize=function(e){this._scene=e;const i=Le(this);this._cluster=i,this._removeEventListener=e.camera.changed.addEventListener(i)};Object.defineProperties(L.prototype,{enabled:{get:function(){return this._enabled},set:function(e){this._enabledDirty=e!==this._enabled,this._enabled=e}},pixelRange:{get:function(){return this._pixelRange},set:function(e){this._clusterDirty=this._clusterDirty||e!==this._pixelRange,this._pixelRange=e}},minimumClusterSize:{get:function(){return this._minimumClusterSize},set:function(e){this._clusterDirty=this._clusterDirty||e!==this._minimumClusterSize,this._minimumClusterSize=e}},clusterEvent:{get:function(){return this._clusterEvent}},clusterBillboards:{get:function(){return this._clusterBillboards},set:function(e){this._clusterDirty=this._clusterDirty||e!==this._clusterBillboards,this._clusterBillboards=e}},clusterLabels:{get:function(){return this._clusterLabels},set:function(e){this._clusterDirty=this._clusterDirty||e!==this._clusterLabels,this._clusterLabels=e}},clusterPoints:{get:function(){return this._clusterPoints},set:function(e){this._clusterDirty=this._clusterDirty||e!==this._clusterPoints,this._clusterPoints=e}}});function F(e,i,t,n){return function(o){let c=this[e];Cesium.defined(this._collectionIndicesByEntity)||(this._collectionIndicesByEntity={});let s=this._collectionIndicesByEntity[o.id];if(Cesium.defined(s)||(s=this._collectionIndicesByEntity[o.id]={billboardIndex:void 0,labelIndex:void 0,pointIndex:void 0}),Cesium.defined(c)&&Cesium.defined(s[n]))return c.get(s[n]);Cesium.defined(c)||(c=this[e]=new i({scene:this._scene}));let l,u;const r=this[t];r.length>0?(l=r.pop(),u=c.get(l)):(u=c.add(),l=c.length-1),s[n]=l;const _=this;return Promise.resolve().then(function(){_._clusterDirty=!0}),u}}function Y(e,i){const t=e._collectionIndicesByEntity[i];!Cesium.defined(t.billboardIndex)&&!Cesium.defined(t.labelIndex)&&!Cesium.defined(t.pointIndex)&&delete e._collectionIndicesByEntity[i]}L.prototype.getLabel=F("_labelCollection",Cesium.LabelCollection,"_unusedLabelIndices","labelIndex");L.prototype.removeLabel=function(e){const i=this._collectionIndicesByEntity&&this._collectionIndicesByEntity[e.id];if(!Cesium.defined(this._labelCollection)||!Cesium.defined(i)||!Cesium.defined(i.labelIndex))return;const t=i.labelIndex;i.labelIndex=void 0,Y(this,e.id);const n=this._labelCollection.get(t);n.show=!1,n.text="",n.id=void 0,this._unusedLabelIndices.push(t),this._clusterDirty=!0};L.prototype.getBillboard=F("_billboardCollection",Cesium.BillboardCollection,"_unusedBillboardIndices","billboardIndex");L.prototype.removeBillboard=function(e){const i=this._collectionIndicesByEntity&&this._collectionIndicesByEntity[e.id];if(!Cesium.defined(this._billboardCollection)||!Cesium.defined(i)||!Cesium.defined(i.billboardIndex))return;const t=i.billboardIndex;i.billboardIndex=void 0,Y(this,e.id);const n=this._billboardCollection.get(t);n.id=void 0,n.show=!1,n.image=void 0,this._unusedBillboardIndices.push(t),this._clusterDirty=!0};L.prototype.getPoint=F("_pointCollection",Cesium.PointPrimitiveCollection,"_unusedPointIndices","pointIndex");L.prototype.removePoint=function(e){const i=this._collectionIndicesByEntity&&this._collectionIndicesByEntity[e.id];if(!Cesium.defined(this._pointCollection)||!Cesium.defined(i)||!Cesium.defined(i.pointIndex))return;const t=i.pointIndex;i.pointIndex=void 0,Y(this,e.id);const n=this._pointCollection.get(t);n.show=!1,n.id=void 0,this._unusedPointIndices.push(t),this._clusterDirty=!0};function U(e){if(!Cesium.defined(e))return;const i=e.length;for(let t=0;t<i;++t)e.get(t).clusterShow=!0}function Pe(e){e.enabled||(Cesium.defined(e._clusterLabelCollection)&&e._clusterLabelCollection.destroy(),Cesium.defined(e._clusterBillboardCollection)&&e._clusterBillboardCollection.destroy(),Cesium.defined(e._clusterPointCollection)&&e._clusterPointCollection.destroy(),e._clusterLabelCollection=void 0,e._clusterBillboardCollection=void 0,e._clusterPointCollection=void 0,U(e._labelCollection),U(e._billboardCollection),U(e._pointCollection))}L.prototype.update=function(e){if(!this.show)return;let i;Cesium.defined(this._labelCollection)&&this._labelCollection.length>0&&this._labelCollection.get(0)._glyphs.length===0&&(i=e.commandList,e.commandList=[],this._labelCollection.update(e),e.commandList=i),Cesium.defined(this._billboardCollection)&&this._billboardCollection.length>0&&!Cesium.defined(this._billboardCollection.get(0).width)&&(i=e.commandList,e.commandList=[],this._billboardCollection.update(e),e.commandList=i),this._enabledDirty&&(this._enabledDirty=!1,Pe(this),this._clusterDirty=!0),this._clusterDirty&&(this._clusterDirty=!1,this._cluster()),Cesium.defined(this._clusterLabelCollection)&&this._clusterLabelCollection.update(e),Cesium.defined(this._clusterBillboardCollection)&&this._clusterBillboardCollection.update(e),Cesium.defined(this._clusterPointCollection)&&this._clusterPointCollection.update(e),Cesium.defined(this._labelCollection)&&this._labelCollection.update(e),Cesium.defined(this._billboardCollection)&&this._billboardCollection.update(e),Cesium.defined(this._pointCollection)&&this._pointCollection.update(e)};L.prototype.destroy=function(){this._labelCollection=this._labelCollection&&this._labelCollection.destroy(),this._billboardCollection=this._billboardCollection&&this._billboardCollection.destroy(),this._pointCollection=this._pointCollection&&this._pointCollection.destroy(),this._clusterLabelCollection=this._clusterLabelCollection&&this._clusterLabelCollection.destroy(),this._clusterBillboardCollection=this._clusterBillboardCollection&&this._clusterBillboardCollection.destroy(),this._clusterPointCollection=this._clusterPointCollection&&this._clusterPointCollection.destroy(),Cesium.defined(this._removeEventListener)&&(this._removeEventListener(),this._removeEventListener=void 0),this._labelCollection=void 0,this._billboardCollection=void 0,this._pointCollection=void 0,this._clusterBillboardCollection=void 0,this._clusterLabelCollection=void 0,this._clusterPointCollection=void 0,this._collectionIndicesByEntity=void 0,this._unusedLabelIndices=[],this._unusedBillboardIndices=[],this._unusedPointIndices=[],this._previousClusters=[],this._previousHeight=void 0,this._enabledDirty=!1,this._pixelRangeDirty=!1,this._minimumClusterSizeDirty=!1};const Me={__name:"primitive",setup(e){const i=se(),{viewer:t}=i.state,n=ce(),o=t.scene.primitives.add(new Cesium.BillboardCollection);let c=new Cesium.BillboardCollection,s=null,l=null,u=[];const r=()=>{Z("/json/chuzhong.geojson").then(({res:a})=>{console.log(a);const{features:f}=a;u=f,_(f)})},_=a=>{for(let f=0;f<a.length;f++){const d=a[f],m=d.geometry.coordinates,h=Cesium.Cartesian3.fromDegrees(m[0],m[1],1e3);d.properties.name,o._id="mark",o.add({image:"/images/mark-icon.png",width:32,height:32,position:h})}},p=t.scene;new Cesium.ScreenSpaceEventHandler(p.canvas).setInputAction(a=>{console.log("xxxx",a);const f=p.pick(a.position);if(Cesium.defined(f)&&f.collection._id.indexOf("mark")>-1){const d=u[f.primitive._index],m={viewer:t,position:{_value:f.primitive.position},title:d.properties.name,content:d.properties.address};n.value&&n.value.windowClose(),n.value=new he(m)}},Cesium.ScreenSpaceEventType.LEFT_CLICK);const g=()=>{var a;(a=n.value)==null||a.windowClose()};t.camera.setView({destination:Cesium.Cartesian3.fromDegrees(120.36,36.09,4e4)});const C=()=>{g(),o==null||o.removeAll(),l==null||l.removeAll(),s=null,c=null};de(()=>{C()});const I=()=>{Z("/json/schools.geojson").then(({res:a})=>{console.log(a);const{features:f}=a;x(f)})},x=a=>{s=new Cesium.PrimitiveCollection,c=new Cesium.BillboardCollection;var f=t.scene;let d=null;d=new L,d.enabled=!0,d.pixelRange=60,d.minimumClusterSize=2;for(let m=0;m<a.length;m++){const w=a[m].geometry.coordinates,P=Cesium.Cartesian3.fromDegrees(w[0],w[1],2e3);c.add({image:"/images/mark-icon.png",width:32,height:32,position:P})}return d._billboardCollection=c,d._initialize(f),s.add(d),l=t.scene.primitives.add(s),d.clusterEvent.addEventListener((m,h)=>{h.label.show=!1,h.billboard.show=!0,h.billboard.verticalOrigin=Cesium.VerticalOrigin.BOTTOM,h.billboard.image=A("/images/school-icon.png",m.length,64),h.billboard._imageHeight=60,h.billboard._imageWidth=60,h.billboard._dirty=!1,h.billboard.width=40,h.billboard.height=40}),d};function A(a,f,d){let m=document.createElement("canvas");m.width=d,m.height=d;let h=m.getContext("2d");return new Cesium.Resource.fetchImage(a).then(P=>{try{h.drawImage(P,0,0)}catch(M){console.log(M)}return h.fillStyle=Cesium.Color.BLACK.toCssColorString(),h.font="bold 20px Microsoft YaHei",h.textAlign="center",h.textBaseline="middle",h.fillText(f,d/2,d/2),m})}return(a,f)=>{const d=ae,m=le;return ue(),re(m,null,{default:T(()=>[j(d,{type:"primary",onClick:r},{default:T(()=>[N("\u6253\u70B9")]),_:1}),j(d,{type:"primary",onClick:I},{default:T(()=>[N("primitive\u6253\u70B9\u805A\u5408")]),_:1}),j(d,{type:"primary",onClick:C},{default:T(()=>[N("\u6E05\u9664\u6253\u70B9")]),_:1})]),_:1})}}};export{Me as default};
