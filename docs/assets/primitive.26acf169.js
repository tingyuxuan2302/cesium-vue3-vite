import{_ as le}from"./OperateBox.0986405a.js";import{h as se,a as ce,o as de,c as ue,w as T,d as j,e as N}from"./index.fe5814f1.js";import{E as re}from"./el-button.af2fec77.js";import{g as Z}from"./api.cf71c671.js";import{D as ae}from"./dialog.232ce2d8.js";import"./request.6255f877.js";import"./axios.a5b46551.js";function W(e,i,t,n,o,c){if(o-n<=t)return;const l=n+o>>1;ee(e,i,l,n,o,c%2),W(e,i,t,n,l-1,c+1),W(e,i,t,l+1,o,c+1)}function ee(e,i,t,n,o,c){for(;o>n;){if(o-n>600){const u=o-n+1,f=t-n+1,B=Math.log(u),b=.5*Math.exp(2*B/3),C=.5*Math.sqrt(B*b*(u-b)/u)*(f-u/2<0?-1:1),p=Math.max(n,Math.floor(t-f*b/u+C)),v=Math.min(o,Math.floor(t+(u-f)*b/u+C));ee(e,i,t,p,v,c)}const l=i[2*t+c];let s=n,d=o;for(V(e,i,n,t),i[2*o+c]>l&&V(e,i,n,o);s<d;){for(V(e,i,s,d),s++,d--;i[2*s+c]<l;)s++;for(;i[2*d+c]>l;)d--}i[2*n+c]===l?V(e,i,n,d):(d++,V(e,i,d,o)),d<=t&&(n=d+1),t<=d&&(o=d-1)}}function V(e,i,t,n){G(e,t,n),G(i,2*t,2*n),G(i,2*t+1,2*n+1)}function G(e,i,t){const n=e[i];e[i]=e[t],e[t]=n}function he(e,i,t,n,o,c,l){const s=[0,e.length-1,0],d=[];let u,f;for(;s.length;){const B=s.pop(),b=s.pop(),C=s.pop();if(b-C<=l){for(let x=C;x<=b;x++)u=i[2*x],f=i[2*x+1],u>=t&&u<=o&&f>=n&&f<=c&&d.push(e[x]);continue}const p=Math.floor((C+b)/2);u=i[2*p],f=i[2*p+1],u>=t&&u<=o&&f>=n&&f<=c&&d.push(e[p]);const v=(B+1)%2;(B===0?t<=u:n<=f)&&(s.push(C),s.push(p-1),s.push(v)),(B===0?o>=u:c>=f)&&(s.push(p+1),s.push(b),s.push(v))}return d}function fe(e,i,t,n,o,c){const l=[0,e.length-1,0],s=[],d=o*o;for(;l.length;){const u=l.pop(),f=l.pop(),B=l.pop();if(f-B<=c){for(let x=B;x<=f;x++)Q(i[2*x],i[2*x+1],t,n)<=d&&s.push(e[x]);continue}const b=Math.floor((B+f)/2),C=i[2*b],p=i[2*b+1];Q(C,p,t,n)<=d&&s.push(e[b]);const v=(u+1)%2;(u===0?t-o<=C:n-o<=p)&&(l.push(B),l.push(b-1),l.push(v)),(u===0?t+o>=C:n+o>=p)&&(l.push(b+1),l.push(f),l.push(v))}return s}function Q(e,i,t,n){const o=e-t,c=i-n;return o*o+c*c}const _e=e=>e[0],me=e=>e[1];class be{constructor(i,t=_e,n=me,o=64,c=Float64Array){this.nodeSize=o,this.points=i;const l=i.length<65536?Uint16Array:Uint32Array,s=this.ids=new l(i.length),d=this.coords=new c(i.length*2);for(let u=0;u<i.length;u++)s[u]=u,d[2*u]=t(i[u]),d[2*u+1]=n(i[u]);W(s,d,o,0,s.length-1,0)}range(i,t,n,o){return he(this.ids,this.coords,i,t,n,o,this.nodeSize)}within(i,t,n){return fe(this.ids,this.coords,i,t,n,this.nodeSize)}}function P(e){e=Cesium.defaultValue(e,Cesium.defaultValue.EMPTY_OBJECT),this._enabled=Cesium.defaultValue(e.enabled,!1),this._pixelRange=Cesium.defaultValue(e.pixelRange,80),this._minimumClusterSize=Cesium.defaultValue(e.minimumClusterSize,2),this._clusterBillboards=Cesium.defaultValue(e.clusterBillboards,!0),this._clusterLabels=Cesium.defaultValue(e.clusterLabels,!0),this._clusterPoints=Cesium.defaultValue(e.clusterPoints,!0),this._labelCollection=void 0,this._billboardCollection=void 0,this._pointCollection=void 0,this._clusterBillboardCollection=void 0,this._clusterLabelCollection=void 0,this._clusterPointCollection=void 0,this._collectionIndicesByEntity={},this._unusedLabelIndices=[],this._unusedBillboardIndices=[],this._unusedPointIndices=[],this._previousClusters=[],this._previousHeight=void 0,this._enabledDirty=!1,this._clusterDirty=!1,this._cluster=void 0,this._removeEventListener=void 0,this._clusterEvent=new Cesium.Event,this.show=Cesium.defaultValue(e.show,!0)}function Ce(e){return e.coord.x}function pe(e){return e.coord.y}function X(e,i){e.x-=i,e.y-=i,e.width+=i*2,e.height+=i*2}const ge=new Cesium.BoundingRectangle;function $(e,i,t,n,o){if(Cesium.defined(e._labelCollection)&&n._clusterLabels?o=Cesium.Label.getScreenSpaceBoundingBox(e,i,o):Cesium.defined(e._billboardCollection)&&n._clusterBillboards?o=Cesium.Billboard.getScreenSpaceBoundingBox(e,i,o):Cesium.defined(e._pointPrimitiveCollection)&&n._clusterPoints&&(o=Cesium.PointPrimitive.getScreenSpaceBoundingBox(e,i,o)),X(o,t),n._clusterLabels&&!Cesium.defined(e._labelCollection)&&Cesium.defined(e.id)&&ie(n,e.id.id)&&Cesium.defined(e.id._label)){const c=n._collectionIndicesByEntity[e.id.id].labelIndex,l=n._labelCollection.get(c),s=Cesium.Label.getScreenSpaceBoundingBox(l,i,ge);X(s,t),o=Cesium.BoundingRectangle.union(o,s,o)}return o}function Be(e,i){if(e.clusterShow=!0,!Cesium.defined(e._labelCollection)&&Cesium.defined(e.id)&&ie(i,e.id.id)&&Cesium.defined(e.id._label)){const t=i._collectionIndicesByEntity[e.id.id].labelIndex,n=i._labelCollection.get(t);n.clusterShow=!0}}function q(e,i,t,n){const o={billboard:n._clusterBillboardCollection.add(),label:n._clusterLabelCollection.add(),point:n._clusterPointCollection.add()};o.billboard.show=!1,o.point.show=!1,o.label.show=!0,o.label.text=i.toLocaleString(),o.label.id=t,o.billboard.position=o.label.position=o.point.position=e,n._clusterEvent.raiseEvent(t,o)}function ie(e,i){return Cesium.defined(e)&&Cesium.defined(e._collectionIndicesByEntity[i])&&Cesium.defined(e._collectionIndicesByEntity[i].labelIndex)}function K(e,i,t,n,o){if(!Cesium.defined(e))return;const c=e.length;for(let l=0;l<c;++l){const s=e.get(l);if(s.clusterShow=!1,!s.show||o._scene.mode===Cesium.SceneMode.SCENE3D&&!n.isPointVisible(s.position))continue;const d=s.computeScreenSpacePosition(t);!Cesium.defined(d)||i.push({index:l,collection:e,clustered:!1,coord:d})}}const xe=new Cesium.BoundingRectangle,we=new Cesium.BoundingRectangle,Ie=new Cesium.BoundingRectangle;function ve(e){return function(i){if(Cesium.defined(i)&&i<.05||!e.enabled)return;const t=e._scene,n=e._labelCollection,o=e._billboardCollection,c=e._pointCollection;if(!Cesium.defined(n)&&!Cesium.defined(o)&&!Cesium.defined(c)||!e._clusterBillboards&&!e._clusterLabels&&!e._clusterPoints)return;let l=e._clusterLabelCollection,s=e._clusterBillboardCollection,d=e._clusterPointCollection;Cesium.defined(l)?l.removeAll():l=e._clusterLabelCollection=new Cesium.LabelCollection({scene:t}),Cesium.defined(s)?s.removeAll():s=e._clusterBillboardCollection=new Cesium.BillboardCollection({scene:t}),Cesium.defined(d)?d.removeAll():d=e._clusterPointCollection=new Cesium.PointPrimitiveCollection;const u=e._pixelRange,f=e._minimumClusterSize,B=e._previousClusters,b=[],C=e._previousHeight,p=t.camera.positionCartographic.height,v=t.mapProjection.ellipsoid,x=t.camera.positionWC,_=new Cesium.EllipsoidalOccluder(v,x),r=[];e._clusterLabels&&K(n,r,t,_,e),e._clusterBillboards&&K(o,r,t,_,e),e._clusterPoints&&K(c,r,t,_,e);let h,a,m,w,I,R,z,E,M,D,H,O;const J=new be(r,Ce,pe,64,Int32Array);if(p<C)for(m=B.length,h=0;h<m;++h){const g=B[h];if(!_.isPointVisible(g.position))continue;const y=Cesium.Billboard._computeScreenSpacePosition(Cesium.Matrix4.IDENTITY,g.position,Cesium.Cartesian3.ZERO,Cesium.Cartesian2.ZERO,t);if(!Cesium.defined(y))continue;const A=1-p/C;let S=g.width=g.width*A,L=g.height=g.height*A;S=Math.max(S,g.minimumWidth),L=Math.max(L,g.minimumHeight);const k=y.x-S*.5,te=y.y-L*.5,ne=y.x+S,oe=y.y+L;for(I=J.range(k,te,ne,oe),R=I.length,D=0,M=[],a=0;a<R;++a)z=I[a],E=r[z],E.clustered||(++D,H=E.collection,O=E.index,M.push(H.get(O).id));if(D>=f)for(q(g.position,D,M,e),b.push(g),a=0;a<R;++a)r[I[a]].clustered=!0}for(m=r.length,h=0;h<m;++h){const g=r[h];if(g.clustered)continue;g.clustered=!0,H=g.collection,O=g.index;const y=H.get(O);w=$(y,g.coord,u,e,xe);const A=Cesium.BoundingRectangle.clone(w,we);I=J.range(w.x,w.y,w.x+w.width,w.y+w.height),R=I.length;const S=Cesium.Cartesian3.clone(y.position);for(D=1,M=[y.id],a=0;a<R;++a)if(z=I[a],E=r[z],!E.clustered){const L=E.collection.get(E.index),k=$(L,E.coord,u,e,Ie);Cesium.Cartesian3.add(L.position,S,S),Cesium.BoundingRectangle.union(A,k,A),++D,M.push(L.id)}if(D>=f){const L=Cesium.Cartesian3.multiplyByScalar(S,1/D,S);for(q(L,D,M,e),b.push({position:L,width:A.width,height:A.height,minimumWidth:w.width,minimumHeight:w.height}),a=0;a<R;++a)r[I[a]].clustered=!0}else Be(y,e)}l.length===0&&(l.destroy(),e._clusterLabelCollection=void 0),s.length===0&&(s.destroy(),e._clusterBillboardCollection=void 0),d.length===0&&(d.destroy(),e._clusterPointCollection=void 0),e._previousClusters=b,e._previousHeight=p}}P.prototype._initialize=function(e){this._scene=e;const i=ve(this);this._cluster=i,this._removeEventListener=e.camera.changed.addEventListener(i)};Object.defineProperties(P.prototype,{enabled:{get:function(){return this._enabled},set:function(e){this._enabledDirty=e!==this._enabled,this._enabled=e}},pixelRange:{get:function(){return this._pixelRange},set:function(e){this._clusterDirty=this._clusterDirty||e!==this._pixelRange,this._pixelRange=e}},minimumClusterSize:{get:function(){return this._minimumClusterSize},set:function(e){this._clusterDirty=this._clusterDirty||e!==this._minimumClusterSize,this._minimumClusterSize=e}},clusterEvent:{get:function(){return this._clusterEvent}},clusterBillboards:{get:function(){return this._clusterBillboards},set:function(e){this._clusterDirty=this._clusterDirty||e!==this._clusterBillboards,this._clusterBillboards=e}},clusterLabels:{get:function(){return this._clusterLabels},set:function(e){this._clusterDirty=this._clusterDirty||e!==this._clusterLabels,this._clusterLabels=e}},clusterPoints:{get:function(){return this._clusterPoints},set:function(e){this._clusterDirty=this._clusterDirty||e!==this._clusterPoints,this._clusterPoints=e}}});function F(e,i,t,n){return function(o){let c=this[e];Cesium.defined(this._collectionIndicesByEntity)||(this._collectionIndicesByEntity={});let l=this._collectionIndicesByEntity[o.id];if(Cesium.defined(l)||(l=this._collectionIndicesByEntity[o.id]={billboardIndex:void 0,labelIndex:void 0,pointIndex:void 0}),Cesium.defined(c)&&Cesium.defined(l[n]))return c.get(l[n]);Cesium.defined(c)||(c=this[e]=new i({scene:this._scene}));let s,d;const u=this[t];u.length>0?(s=u.pop(),d=c.get(s)):(d=c.add(),s=c.length-1),l[n]=s;const f=this;return Promise.resolve().then(function(){f._clusterDirty=!0}),d}}function Y(e,i){const t=e._collectionIndicesByEntity[i];!Cesium.defined(t.billboardIndex)&&!Cesium.defined(t.labelIndex)&&!Cesium.defined(t.pointIndex)&&delete e._collectionIndicesByEntity[i]}P.prototype.getLabel=F("_labelCollection",Cesium.LabelCollection,"_unusedLabelIndices","labelIndex");P.prototype.removeLabel=function(e){const i=this._collectionIndicesByEntity&&this._collectionIndicesByEntity[e.id];if(!Cesium.defined(this._labelCollection)||!Cesium.defined(i)||!Cesium.defined(i.labelIndex))return;const t=i.labelIndex;i.labelIndex=void 0,Y(this,e.id);const n=this._labelCollection.get(t);n.show=!1,n.text="",n.id=void 0,this._unusedLabelIndices.push(t),this._clusterDirty=!0};P.prototype.getBillboard=F("_billboardCollection",Cesium.BillboardCollection,"_unusedBillboardIndices","billboardIndex");P.prototype.removeBillboard=function(e){const i=this._collectionIndicesByEntity&&this._collectionIndicesByEntity[e.id];if(!Cesium.defined(this._billboardCollection)||!Cesium.defined(i)||!Cesium.defined(i.billboardIndex))return;const t=i.billboardIndex;i.billboardIndex=void 0,Y(this,e.id);const n=this._billboardCollection.get(t);n.id=void 0,n.show=!1,n.image=void 0,this._unusedBillboardIndices.push(t),this._clusterDirty=!0};P.prototype.getPoint=F("_pointCollection",Cesium.PointPrimitiveCollection,"_unusedPointIndices","pointIndex");P.prototype.removePoint=function(e){const i=this._collectionIndicesByEntity&&this._collectionIndicesByEntity[e.id];if(!Cesium.defined(this._pointCollection)||!Cesium.defined(i)||!Cesium.defined(i.pointIndex))return;const t=i.pointIndex;i.pointIndex=void 0,Y(this,e.id);const n=this._pointCollection.get(t);n.show=!1,n.id=void 0,this._unusedPointIndices.push(t),this._clusterDirty=!0};function U(e){if(!Cesium.defined(e))return;const i=e.length;for(let t=0;t<i;++t)e.get(t).clusterShow=!0}function Le(e){e.enabled||(Cesium.defined(e._clusterLabelCollection)&&e._clusterLabelCollection.destroy(),Cesium.defined(e._clusterBillboardCollection)&&e._clusterBillboardCollection.destroy(),Cesium.defined(e._clusterPointCollection)&&e._clusterPointCollection.destroy(),e._clusterLabelCollection=void 0,e._clusterBillboardCollection=void 0,e._clusterPointCollection=void 0,U(e._labelCollection),U(e._billboardCollection),U(e._pointCollection))}P.prototype.update=function(e){if(!this.show)return;let i;Cesium.defined(this._labelCollection)&&this._labelCollection.length>0&&this._labelCollection.get(0)._glyphs.length===0&&(i=e.commandList,e.commandList=[],this._labelCollection.update(e),e.commandList=i),Cesium.defined(this._billboardCollection)&&this._billboardCollection.length>0&&!Cesium.defined(this._billboardCollection.get(0).width)&&(i=e.commandList,e.commandList=[],this._billboardCollection.update(e),e.commandList=i),this._enabledDirty&&(this._enabledDirty=!1,Le(this),this._clusterDirty=!0),this._clusterDirty&&(this._clusterDirty=!1,this._cluster()),Cesium.defined(this._clusterLabelCollection)&&this._clusterLabelCollection.update(e),Cesium.defined(this._clusterBillboardCollection)&&this._clusterBillboardCollection.update(e),Cesium.defined(this._clusterPointCollection)&&this._clusterPointCollection.update(e),Cesium.defined(this._labelCollection)&&this._labelCollection.update(e),Cesium.defined(this._billboardCollection)&&this._billboardCollection.update(e),Cesium.defined(this._pointCollection)&&this._pointCollection.update(e)};P.prototype.destroy=function(){this._labelCollection=this._labelCollection&&this._labelCollection.destroy(),this._billboardCollection=this._billboardCollection&&this._billboardCollection.destroy(),this._pointCollection=this._pointCollection&&this._pointCollection.destroy(),this._clusterLabelCollection=this._clusterLabelCollection&&this._clusterLabelCollection.destroy(),this._clusterBillboardCollection=this._clusterBillboardCollection&&this._clusterBillboardCollection.destroy(),this._clusterPointCollection=this._clusterPointCollection&&this._clusterPointCollection.destroy(),Cesium.defined(this._removeEventListener)&&(this._removeEventListener(),this._removeEventListener=void 0),this._labelCollection=void 0,this._billboardCollection=void 0,this._pointCollection=void 0,this._clusterBillboardCollection=void 0,this._clusterLabelCollection=void 0,this._clusterPointCollection=void 0,this._collectionIndicesByEntity=void 0,this._unusedLabelIndices=[],this._unusedBillboardIndices=[],this._unusedPointIndices=[],this._previousClusters=[],this._previousHeight=void 0,this._enabledDirty=!1,this._pixelRangeDirty=!1,this._minimumClusterSizeDirty=!1};const Me={__name:"primitive",setup(e){const{viewer:i}=window,t=se(),n=i.scene.primitives.add(new Cesium.BillboardCollection);let o=new Cesium.BillboardCollection,c=null,l=null,s=[];const d=()=>{Z("/cesium-vue3-vite/json/chuzhong.geojson").then(({res:_})=>{console.log(_);const{features:r}=_;s=r,u(r)})},u=_=>{for(let r=0;r<_.length;r++){const h=_[r],a=h.geometry.coordinates,m=Cesium.Cartesian3.fromDegrees(a[0],a[1],1e3);h.properties.name,n._id="mark",n.add({image:"/cesium-vue3-vite/images/mark-icon.png",width:32,height:32,position:m})}},f=i.scene;new Cesium.ScreenSpaceEventHandler(f.canvas).setInputAction(_=>{console.log("xxxx",_);const r=f.pick(_.position);if(Cesium.defined(r)&&r.collection._id.indexOf("mark")>-1){const h=s[r.primitive._index],a={viewer:i,position:{_value:r.primitive.position},title:h.properties.name,content:h.properties.address};t.value&&t.value.windowClose(),t.value=new ae(a)}},Cesium.ScreenSpaceEventType.LEFT_CLICK);const b=()=>{var _;(_=t.value)==null||_.windowClose()};i.camera.setView({destination:Cesium.Cartesian3.fromDegrees(120.36,36.09,4e4)});const C=()=>{b(),n==null||n.removeAll(),l==null||l.removeAll(),c=null,o=null};ce(()=>{C()});const p=()=>{Z("/cesium-vue3-vite/json/schools.geojson").then(({res:_})=>{console.log(_);const{features:r}=_;v(r)})},v=_=>{c=new Cesium.PrimitiveCollection,o=new Cesium.BillboardCollection;var r=i.scene;let h=null;h=new P,h.enabled=!0,h.pixelRange=60,h.minimumClusterSize=2;for(let a=0;a<_.length;a++){const w=_[a].geometry.coordinates,I=Cesium.Cartesian3.fromDegrees(w[0],w[1],2e3);o.add({image:"/cesium-vue3-vite/images/mark-icon.png",width:32,height:32,position:I})}return h._billboardCollection=o,h._initialize(r),c.add(h),l=i.scene.primitives.add(c),h.clusterEvent.addEventListener((a,m)=>{m.label.show=!1,m.billboard.show=!0,m.billboard.verticalOrigin=Cesium.VerticalOrigin.BOTTOM,m.billboard.image=x("/cesium-vue3-vite/images/school-icon.png",a.length,64),m.billboard._imageHeight=60,m.billboard._imageWidth=60,m.billboard._dirty=!1,m.billboard.width=40,m.billboard.height=40}),h};function x(_,r,h){let a=document.createElement("canvas");a.width=h,a.height=h;let m=a.getContext("2d");return new Cesium.Resource.fetchImage(_).then(I=>{try{m.drawImage(I,0,0)}catch(R){console.log(R)}return m.fillStyle=Cesium.Color.BLACK.toCssColorString(),m.font="bold 20px Microsoft YaHei",m.textAlign="center",m.textBaseline="middle",m.fillText(r,h/2,h/2),a})}return(_,r)=>{const h=re,a=le;return de(),ue(a,null,{default:T(()=>[j(h,{type:"primary",onClick:d},{default:T(()=>r[0]||(r[0]=[N("\u6253\u70B9")])),_:1}),j(h,{type:"primary",onClick:p},{default:T(()=>r[1]||(r[1]=[N("primitive\u6253\u70B9\u805A\u5408")])),_:1}),j(h,{type:"primary",onClick:C},{default:T(()=>r[2]||(r[2]=[N("\u6E05\u9664\u6253\u70B9")])),_:1})]),_:1})}}};export{Me as default};
