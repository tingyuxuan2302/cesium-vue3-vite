const ge=function(){const M=function(r){return r.reduce(function(e,c){return e*2+c},0)},j=function(r){const e=[];for(let c=7;c>=0;c--)e.push(!!(r&1<<c));return e},J=function(r){this.data=r,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return r instanceof Uint8Array?r[this.pos++]:r.charCodeAt(this.pos++)&255},this.readBytes=function(e){const c=[];for(let a=0;a<e;a++)c.push(this.readByte());return c},this.read=function(e){let c="";for(let a=0;a<e;a++)c+=String.fromCharCode(this.readByte());return c},this.readUnsigned=function(){const e=this.readBytes(2);return(e[1]<<8)+e[0]}},oe=function(r,e){let c=0;const a=function(u){let w=0;for(let m=0;m<u;m++)e.charCodeAt(c>>3)&1<<(c&7)&&(w|=1<<m),c++;return w},F=[],E=1<<r,N=E+1;let P=r+1,p=[];const t=function(){p=[],P=r+1;for(let u=0;u<E;u++)p[u]=[u];p[E]=[],p[N]=null};let s,l;for(;;){if(l=s,s=a(P),s===E){t();continue}if(s===N)break;if(s<p.length)l!==E&&p.push(p[l].concat(p[s][0]));else{if(s!==p.length)throw new Error("Invalid LZW code.");p.push(p[l].concat(p[l][0]))}F.push.apply(F,p[s]),p.length===1<<P&&P<12&&P++}return F},ie=function(r,e){e||(e={});const c=function(t){const s=[];for(let l=0;l<t;l++)s.push(r.readBytes(3));return s},a=function(){let t,s;s="";do t=r.readByte(),s+=r.read(t);while(t!==0);return s},F=function(){const t={};if(t.sig=r.read(3),t.ver=r.read(3),t.sig!=="GIF")throw new Error("Not a GIF file.");t.width=r.readUnsigned(),t.height=r.readUnsigned();const s=j(r.readByte());t.gctFlag=s.shift(),t.colorRes=M(s.splice(0,3)),t.sorted=s.shift(),t.gctSize=M(s.splice(0,3)),t.bgColor=r.readByte(),t.pixelAspectRatio=r.readByte(),t.gctFlag&&(t.gct=c(1<<t.gctSize+1)),e.hdr&&e.hdr(t)},E=function(t){const s=function(o){r.readByte();const x=j(r.readByte());o.reserved=x.splice(0,3),o.disposalMethod=M(x.splice(0,3)),o.userInput=x.shift(),o.transparencyGiven=x.shift(),o.delayTime=r.readUnsigned(),o.transparencyIndex=r.readByte(),o.terminator=r.readByte(),e.gce&&e.gce(o)},l=function(o){o.comment=a(),e.com&&e.com(o)},u=function(o){r.readByte(),o.ptHeader=r.readBytes(12),o.ptData=a(),e.pte&&e.pte(o)},w=function(o){const x=function(v){r.readByte(),v.unknown=r.readByte(),v.iterations=r.readUnsigned(),v.terminator=r.readByte(),e.app&&e.app.NETSCAPE&&e.app.NETSCAPE(v)},g=function(v){v.appData=a(),e.app&&e.app[v.identifier]&&e.app[v.identifier](v)};switch(r.readByte(),o.identifier=r.read(8),o.authCode=r.read(3),o.identifier){case"NETSCAPE":x(o);break;default:g(o);break}},m=function(o){o.data=a(),e.unknown&&e.unknown(o)};switch(t.label=r.readByte(),t.label){case 249:t.extType="gce",s(t);break;case 254:t.extType="com",l(t);break;case 1:t.extType="pte",u(t);break;case 255:t.extType="app",w(t);break;default:t.extType="unknown",m(t);break}},N=function(t){const s=function(w,m){const o=new Array(w.length),x=w.length/m,g=function(S,U){const V=w.slice(U*m,(U+1)*m);o.splice.apply(o,[S*m,m].concat(V))},v=[0,4,2,1],q=[8,8,4,2];let L=0;for(let S=0;S<4;S++)for(let U=v[S];U<x;U+=q[S])g(U,L),L++;return o};t.leftPos=r.readUnsigned(),t.topPos=r.readUnsigned(),t.width=r.readUnsigned(),t.height=r.readUnsigned();const l=j(r.readByte());t.lctFlag=l.shift(),t.interlaced=l.shift(),t.sorted=l.shift(),t.reserved=l.splice(0,2),t.lctSize=M(l.splice(0,3)),t.lctFlag&&(t.lct=c(1<<t.lctSize+1)),t.lzwMinCodeSize=r.readByte();const u=a();t.pixels=oe(t.lzwMinCodeSize,u),t.interlaced&&(t.pixels=s(t.pixels,t.width)),e.img&&e.img(t)},P=function(){const t={};switch(t.sentinel=r.readByte(),String.fromCharCode(t.sentinel)){case"!":t.type="ext",E(t);break;case",":t.type="img",N(t);break;case";":t.type="eof",e.eof&&e.eof(t);break;default:throw new Error("Unknown block: 0x"+t.sentinel.toString(16))}t.type!=="eof"&&setTimeout(P,0)};(function(){F(),setTimeout(P,0)})()};return function(r){const e={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(const n in r)e[n]=r[n];e.vp_w&&e.vp_h&&(e.is_vp=!0);let c,a,F=null,E=!1,N=null,P=null,p=null,t=null,s=null,l=null,u=null,w=!0,m=!1,o=[],x=[],g=r.gif;typeof e.auto_play>"u"&&(e.auto_play=!g.getAttribute("rel:auto_play")||g.getAttribute("rel:auto_play")=="1");let v=r.hasOwnProperty("on_end")?r.on_end:null,q=r.hasOwnProperty("loop_delay")?r.loop_delay:0,L=r.hasOwnProperty("loop_mode")?r.loop_mode:"auto",S=r.hasOwnProperty("draw_while_loading")?r.draw_while_loading:!0,U=S?r.hasOwnProperty("show_progress_bar")?r.show_progress_bar:!0:!1,V=r.hasOwnProperty("progressbar_height")?r.progressbar_height:25,ae=r.hasOwnProperty("progressbar_background_color")?r.progressbar_background_color:"rgba(255,255,255,0.4)",se=r.hasOwnProperty("progressbar_foreground_color")?r.progressbar_foreground_color:"rgba(255,0,22,.8)";const K=function(){N=null,P=null,s=p,p=null,l=null},Q=function(){try{ie(c,de)}catch{X("parse")}},Y=function(n,i){C.width=n*B(),C.height=i*B(),O.style.minWidth=n*B()+"px",A.width=n,A.height=i,A.style.width=n+"px",A.style.height=i+"px",A.getContext("2d").setTransform(1,0,0,1,0,0)},le=function(n,i){if(!x[n]){x[n]=i;return}typeof i.x<"u"&&(x[n].x=i.x),typeof i.y<"u"&&(x[n].y=i.y)},$=function(n,i,f){if(f&&U){let d=V,y,T,R,W,_,G,D,I;e.is_vp?(m?(_=e.vp_l/B(),G=e.vp_t/B(),D=e.vp_w/B(),I=e.vp_h/B()):(_=e.vp_l,G=e.vp_t,D=e.vp_w,I=e.vp_h),R=G+I-d,d=d,y=_,T=y+n/i*D,W=C.width):(R=C.height-d,y=0,T=n/i*C.width,W=C.width),h.fillStyle=ae,h.fillRect(T,R,W-T,d),h.fillStyle=se,h.fillRect(0,R,T,d)}},X=function(n){const i=function(){h.fillStyle="black",h.fillRect(0,0,e.c_w?e.c_w:a.width,e.c_h?e.c_h:a.height),h.strokeStyle="red",h.lineWidth=3,h.moveTo(0,0),h.lineTo(e.c_w?e.c_w:a.width,e.c_h?e.c_h:a.height),h.moveTo(0,e.c_h?e.c_h:a.height),h.lineTo(e.c_w?e.c_w:a.width,0),h.stroke()};F=n,a={width:g.width,height:g.height},o=[],i()},ce=function(n){a=n,Y(a.width,a.height)},ue=function(n){k(),K(),N=n.transparencyGiven?n.transparencyIndex:null,P=n.delayTime,p=n.disposalMethod},k=function(){!l||(o.push({data:l.getImageData(0,0,a.width,a.height),delay:P}),x.push({x:0,y:0}))},fe=function(n){l||(l=A.getContext("2d"));let i=o.length,f=n.lctFlag?n.lct:a.gct;i>0&&(s===3?t!==null?l.putImageData(o[t].data,0,0):l.clearRect(u.leftPos,u.topPos,u.width,u.height):t=i-1,s===2&&l.clearRect(u.leftPos,u.topPos,u.width,u.height));let d=l.getImageData(n.leftPos,n.topPos,n.width,n.height);n.pixels.forEach(function(y,T){y!==N&&(d.data[T*4+0]=f[y][0],d.data[T*4+1]=f[y][1],d.data[T*4+2]=f[y][2],d.data[T*4+3]=255)}),l.putImageData(d,n.leftPos,n.topPos),m||(h.scale(B(),B()),m=!0),S&&(h.drawImage(A,0,0),S=e.auto_play),u=n},b=function(){let n=-1,i=0,f=function(){return(n+1+o.length)%o.length},d=function(_){n=n+_,T()},y=function(){let _=!1,G=function(){v!==null&&v(g),i++,L!==!1||i<0?D():(_=!1,w=!1)},D=function(){if(_=w,!_)return;d(1);let I=o[n].delay*10;I||(I=100),f()===0?(I+=q,setTimeout(G,I)):setTimeout(D,I)};return function(){_||setTimeout(D,0)}}(),T=function(){let _;n=parseInt(n,10),n>o.length-1&&(n=0),n<0&&(n=0),_=x[n],A.getContext("2d").putImageData(o[n].data,_.x,_.y),h.globalCompositeOperation="copy",h.drawImage(A,0,0)};return{init:function(){F||(e.c_w&&e.c_h||h.scale(B(),B()),e.auto_play?y():(n=0,T()))},step:y,play:function(){w=!0,y()},pause:function(){w=!1},playing:w,move_relative:d,current_frame:function(){return n},length:function(){return o.length},move_to:function(_){n=_,T()}}}();let ee=function(n){$(c.pos,c.data.length,n)},te=function(){},z=function(n,i){return function(f){n(f),ee(i)}},de={hdr:z(ce),gce:z(ue),com:z(te),app:{NETSCAPE:z(te)},img:z(fe,!0),eof:function(n){k(),ee(!1),e.c_w&&e.c_h||(C.width=a.width*B(),C.height=a.height*B()),b.init(),E=!1,H&&H(g)}},ne=function(){let n=g.parentNode,i=document.createElement("div");C=document.createElement("canvas"),h=C.getContext("2d"),O=document.createElement("div"),A=document.createElement("canvas"),i.width=C.width=g.width,i.height=C.height=g.height,O.style.minWidth=g.width+"px",i.className="jsgif",O.className="jsgif_toolbar",i.appendChild(C),i.appendChild(O),n.insertBefore(i,g),n.removeChild(g),e.c_w&&e.c_h&&Y(e.c_w,e.c_h),Z=!0},B=function(){let n;return e.max_width&&a&&a.width>e.max_width?n=e.max_width/a.width:n=1,n},C,h,O,A,Z=!1,H=!1,re=function(n){return E?!1:(n?H=n:H=!1,E=!0,o=[],K(),t=null,s=null,l=null,u=null,!0)};return{play:b.play,pause:b.pause,move_relative:b.move_relative,move_to:b.move_to,get_playing:function(){return w},get_canvas:function(){return C},get_canvas_scale:function(){return B()},get_loading:function(){return E},get_auto_play:function(){return e.auto_play},get_length:function(){return b.length()},get_current_frame:function(){return b.current_frame()},load_url:function(n,i){if(!re(i))return;let f=new XMLHttpRequest;f.open("GET",n,!0),"overrideMimeType"in f?f.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in f?f.responseType="arraybuffer":f.setRequestHeader("Accept-Charset","x-user-defined"),f.onloadstart=function(){Z||ne()},f.onload=function(d){this.status!=200&&X("xhr - response"),"response"in this||(this.response=new VBArray(this.responseText).toArray().map(String.fromCharCode).join(""));let y=this.response;y.toString().indexOf("ArrayBuffer")>0&&(y=new Uint8Array(y)),c=new J(y),setTimeout(Q,0)},f.onprogress=function(d){d.lengthComputable&&$(d.loaded,d.total,!0)},f.onerror=function(){X("xhr")},f.send()},load:function(n){this.load_url(g.getAttribute("rel:animated_src")||g.src,n)},load_raw:function(n,i){!re(i)||(Z||ne(),c=new J(n),setTimeout(Q,0))},set_frame_offset:le}}}();export{ge as S};
