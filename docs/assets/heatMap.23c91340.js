import{_ as E}from"./OperateBox.5dea2f2a.js";import{a as L,o as I,c as S,w as O,d as R,e as M}from"./index.76f76e18.js";import{E as B}from"./el-button.46cdb001.js";import{g as F}from"./api.47e7af23.js";import"./request.353a8dae.js";import"./axios.a5b46551.js";var D={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},P=function(){var s=function(a){this._coordinator={},this._data=[],this._radi=[],this._min=0,this._max=1,this._xField=a.xField||a.defaultXField,this._yField=a.yField||a.defaultYField,this._valueField=a.valueField||a.defaultValueField,a.radius&&(this._cfgRadius=a.radius)},h=D.defaultRadius;return s.prototype={_organiseData:function(r,a){var t=r[this._xField],e=r[this._yField],n=this._radi,i=this._data,d=this._max,o=this._min,m=r[this._valueField]||1,p=r.radius||this._cfgRadius||h;return i[t]||(i[t]=[],n[t]=[]),i[t][e]?i[t][e]+=m:(i[t][e]=m,n[t][e]=p),i[t][e]>d?(a?this.setDataMax(i[t][e]):this._max=i[t][e],!1):{x:t,y:e,value:m,radius:p,min:o,max:d}},_unOrganizeData:function(){var r=[],a=this._data,t=this._radi;for(var e in a)for(var n in a[e])r.push({x:e,y:n,radius:t[e][n],value:a[e][n]});return{min:this._min,max:this._max,data:r}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(arguments[0].length>0)for(var r=arguments[0],a=r.length;a--;)this.addData.call(this,r[a]);else{var t=this._organiseData(arguments[0],!0);t&&this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[t]})}return this},setData:function(r){var a=r.data,t=a.length;this._data=[],this._radi=[];for(var e=0;e<t;e++)this._organiseData(a[e],!1);return this._max=r.max,this._min=r.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(r){return this._max=r,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(r){return this._min=r,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(r){this._coordinator=r},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},s}(),G=function(){var s=function(t){var e=t.gradient||t.defaultGradient,n=document.createElement("canvas"),i=n.getContext("2d");n.width=256,n.height=1;var d=i.createLinearGradient(0,0,256,1);for(var o in e)d.addColorStop(o,e[o]);return i.fillStyle=d,i.fillRect(0,0,256,1),i.getImageData(0,0,256,1).data},h=function(t,e){var n=document.createElement("canvas"),i=n.getContext("2d"),d=t,o=t;if(n.width=n.height=t*2,e==1)i.beginPath(),i.arc(d,o,t,0,2*Math.PI,!1),i.fillStyle="rgba(0,0,0,1)",i.fill();else{var m=i.createRadialGradient(d,o,t*e,d,o,t);m.addColorStop(0,"rgba(0,0,0,1)"),m.addColorStop(1,"rgba(0,0,0,0)"),i.fillStyle=m,i.fillRect(0,0,2*t,2*t)}return n},r=function(o){for(var e=[],n=o.min,i=o.max,d=o.radi,o=o.data,m=Object.keys(o),p=m.length;p--;)for(var _=m[p],c=Object.keys(o[_]),g=c.length;g--;){var l=c[g],y=o[_][l],v=d[_][l];e.push({x:_,y:l,value:y,radius:v})}return{min:n,max:i,data:e}};function a(t){var e=t.container,n=this.shadowCanvas=document.createElement("canvas"),i=this.canvas=t.canvas||document.createElement("canvas");this._renderBoundaries=[1e4,1e4,0,0];var d=getComputedStyle(t.container)||{};i.className="heatmap-canvas",this._width=i.width=n.width=+d.width.replace(/px/,""),this._height=i.height=n.height=+d.height.replace(/px/,""),this.shadowCtx=n.getContext("2d"),this.ctx=i.getContext("2d"),i.style.cssText=n.style.cssText="position:absolute;left:0;top:0;",e.style.position="relative",e.appendChild(i),this._palette=s(t),this._templates={},this._setStyles(t)}return a.prototype={renderPartial:function(t){this._drawAlpha(t),this._colorize()},renderAll:function(t){this._clear(),this._drawAlpha(r(t)),this._colorize()},_updateGradient:function(t){this._palette=s(t)},updateConfig:function(t){t.gradient&&this._updateGradient(t),this._setStyles(t)},setDimensions:function(t,e){this._width=t,this._height=e,this.canvas.width=this.shadowCanvas.width=t,this.canvas.height=this.shadowCanvas.height=e},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(t){this._blur=t.blur==0?0:t.blur||t.defaultBlur,t.backgroundColor&&(this.canvas.style.backgroundColor=t.backgroundColor),this._opacity=(t.opacity||0)*255,this._maxOpacity=(t.maxOpacity||t.defaultMaxOpacity)*255,this._minOpacity=(t.minOpacity||t.defaultMinOpacity)*255,this._useGradientOpacity=!!t.useGradientOpacity},_drawAlpha:function(i){for(var e=this._min=i.min,n=this._max=i.max,i=i.data||[],d=i.length,o=1-this._blur;d--;){var m=i[d],p=m.x,_=m.y,c=m.radius,g=Math.min(m.value,n),l=p-c,y=_-c,v=this.shadowCtx,u;this._templates[c]?u=this._templates[c]:this._templates[c]=u=h(c,o),v.globalAlpha=(g-e)/(n-e),v.drawImage(u,l,y),l<this._renderBoundaries[0]&&(this._renderBoundaries[0]=l),y<this._renderBoundaries[1]&&(this._renderBoundaries[1]=y),l+2*c>this._renderBoundaries[2]&&(this._renderBoundaries[2]=l+2*c),y+2*c>this._renderBoundaries[3]&&(this._renderBoundaries[3]=y+2*c)}},_colorize:function(){var t=this._renderBoundaries[0],e=this._renderBoundaries[1],n=this._renderBoundaries[2]-t,i=this._renderBoundaries[3]-e,d=this._width,o=this._height,m=this._opacity,p=this._maxOpacity,_=this._minOpacity,c=this._useGradientOpacity;t<0&&(t=0),e<0&&(e=0),t+n>d&&(n=d-t),e+i>o&&(i=o-e);for(var g=this.shadowCtx.getImageData(t,e,n,i),l=g.data,y=l.length,v=this._palette,u=3;u<y;u+=4){var w=l[u],x=w*4;if(!!x){var C;m>0?C=m:w<p?w<_?C=_:C=w:C=p,l[u-3]=v[x],l[u-2]=v[x+1],l[u-1]=v[x+2],l[u]=c?v[x+3]:C}}Object.defineProperty(g,"data",{value:l,writable:!0,configurable:!0,enumerable:!0}),this.ctx.putImageData(g,t,e),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(t){var e,n=this.shadowCtx,i=n.getImageData(t.x,t.y,1,1),d=i.data[3],o=this._max,m=this._min;return e=Math.abs(o-m)*(d/255)>>0,e},getDataURL:function(){return this.canvas.toDataURL()}},a}(),T=function(){var s=!1;return D.defaultRenderer==="canvas2d"&&(s=G),s}(),b={merge:function(){for(var f={},s=arguments.length,h=0;h<s;h++){var r=arguments[h];for(var a in r)f[a]=r[a]}return f}},A=function(){var s=function(){function t(){this.cStore={}}return t.prototype={on:function(e,n,i){var d=this.cStore;d[e]||(d[e]=[]),d[e].push(function(o){return n.call(i,o)})},emit:function(e,n){var i=this.cStore;if(i[e])for(var d=i[e].length,o=0;o<d;o++){var m=i[e][o];m(n)}}},t}(),h=function(a){var t=a._renderer,e=a._coordinator,n=a._store;e.on("renderpartial",t.renderPartial,t),e.on("renderall",t.renderAll,t),e.on("extremachange",function(i){a._config.onExtremaChange&&a._config.onExtremaChange({min:i.min,max:i.max,gradient:a._config.gradient||a._config.defaultGradient})}),n.setCoordinator(e)};function r(){var a=this._config=b.merge(D,arguments[0]||{});if(this._coordinator=new s,a.plugin){var t=a.plugin;if(D.plugins[t]){var e=D.plugins[t];this._renderer=new e.renderer(a),this._store=new e.store(a)}else throw new Error("Plugin '"+t+"' not found. Maybe it was not registered.")}else this._renderer=new T(a),this._store=new P(a);h(this)}return r.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(a){return this._config=b.merge(this._config,a),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(a){return this._store.getValueAt?this._store.getValueAt(a):this._renderer.getValueAt?this._renderer.getValueAt(a):null}},r}(),H={create:function(f){return new A(f)},register:function(f,s){D.plugins[f]=s}};class U{constructor(s,h){var r,a,t;if(this.viewer=s,this.initOptions={...h},(r=this.initOptions)!=null&&r.points){const e=this.getBounds(this.initOptions.points);this.bounds=e;const{container:n,width:i,height:d}=this.createContainer(e);this.element=n;const o=[],m=[];for(let v in this.initOptions.points){const u=this.initOptions.points[v],w=(u.x-e[0])/(e[2]-e[0])*i,x=(e[3]-u.y)/(e[3]-e[1])*d,C={x:w,y:x,value:u.value};typeof u.value=="number"&&m.push(u.value),o.push(C)}let p=Math.min(...m),_=Math.max(...m);if((a=this.initOptions)!=null&&a.heatmapDataOptions){const{min:v,max:u}=this.initOptions.heatmapDataOptions;typeof v=="number"&&(p=v),typeof u=="number"&&(_=u)}this.heatmapDataOptions={min:p,max:_};const c={max:_,min:p,data:o},g={maxOpacity:.9,minOpacity:.1,gradient:{".3":"blue",".5":"green",".7":"yellow",".95":"red"}},l=this.initOptions.heatmapOptions?{...g,...this.initOptions.heatmapOptions}:g;(t=this.heatmapOptions)!=null&&t.radius&&(this.initRadius=this.heatmapOptions.radius),this.heatmapOptions={...l};const y={...l,container:n};this.heatmap=H.create(y),this.heatmap.setData(c),this.createLayer(),this.initOptions.noLisenerCamera||this.addLisener(),this.initOptions.zoomToLayer&&e&&this.viewer.camera.flyTo({destination:Cesium.Rectangle.fromDegrees(...e)})}}updateHeatMapMaxMin(s){const{min:h,max:r}=s;this.heatmap&&(typeof h=="number"&&(this.heatmap.setDataMin(h),this.heatmapDataOptions&&(this.heatmapDataOptions.min=h)),typeof r=="number"&&(this.heatmap.setDataMax(r),this.heatmapDataOptions&&(this.heatmapDataOptions.max=r))),this.updateLayer()}updateHeatmap(s){const{heatmapOptions:h}=this;this.heatmap.configure({...h,...s}),this.updateLayer()}updateRadius(s){var a;const{heatmapOptions:h}=this,r=this.heatmap.getData();if(r!=null&&r.data)for(let t in r.data){const e=r.data[t];e.radius=s}this.heatmap.setData(r),this.heatmapOptions={...h,radius:s},this.updateLayer(),(a=this.initOptions)!=null&&a.onRadiusChange&&this.initOptions.onRadiusChange(s)}remove(){this.element&&(document.body.removeChild(this.element),this.element=void 0,this.provider instanceof Cesium.ImageryLayer?(this.provider&&this.viewer.imageryLayers.remove(this.provider),this.createSingleTileImageryLayer()):this.provider instanceof Cesium.Primitive?this.viewer.scene.primitives.remove(this.provider):this.provider instanceof Cesium.Entity&&this.viewer.entities.remove(this.provider),this.cameraMoveEnd&&(this.viewer.camera.moveEnd.removeEventListener(this.cameraMoveEnd),this.cameraMoveEnd=void 0))}createLayer(){this.initOptions.renderType==="primitive"?this.createPrimitive():this.initOptions.renderType==="imagery"?this.createSingleTileImageryLayer():this.createEntity()}createPrimitive(){const s=this.heatmap.getDataURL();this.provider=this.viewer.scene.primitives.add(new Cesium.Primitive({geometryInstances:new Cesium.GeometryInstance({geometry:new Cesium.RectangleGeometry({rectangle:Cesium.Rectangle.fromDegrees(...this.bounds),vertexFormat:Cesium.EllipsoidSurfaceAppearance.VERTEX_FORMAT})}),appearance:new Cesium.EllipsoidSurfaceAppearance({aboveGround:!1}),show:!0})),this.provider&&(this.provider.appearance.material=new Cesium.Material({fabric:{type:"Image",uniforms:{image:s}}}))}createSingleTileImageryLayer(){const s=this.heatmap.getDataURL();this.provider=this.viewer.imageryLayers.addImageryProvider(new Cesium.SingleTileImageryProvider({url:s,rectangle:Cesium.Rectangle.fromDegrees(...this.bounds)}))}getImageMaterialProperty(){const s=this.heatmap.getDataURL();return new Cesium.ImageMaterialProperty({image:s})}createEntity(){this.provider=this.viewer.entities.add({show:!0,rectangle:{coordinates:Cesium.Rectangle.fromDegrees(...this.bounds),material:this.getImageMaterialProperty()}})}updateLayer(){const s=this.heatmap.getDataURL();this.provider instanceof Cesium.ImageryLayer?(this.provider&&this.viewer.imageryLayers.remove(this.provider),this.createSingleTileImageryLayer()):this.provider instanceof Cesium.Primitive?this.provider.appearance.material.uniforms.image=s:this.provider instanceof Cesium.Entity&&this.provider.rectangle&&(this.provider.rectangle.material=this.getImageMaterialProperty())}addLisener(){this.cameraMoveEnd=()=>{var a;if(this.heatmapOptions&&this.heatmap&&this.heatmapDataOptions){const t=this.viewer.camera.getMagnitude(),e=(a=this==null?void 0:this.initOptions)!=null&&a.cameraHeightDistance?this.initOptions.cameraHeightDistance:1e3;if(Math.abs(t-this.lastCameraHeight)>e){this.lastCameraHeight=t;{const n=parseInt((this.initRadius+(100-this.initRadius)*(t-6375e3)/3625e3).toFixed(0));n&&this.updateRadius(n)}}}},this.viewer.camera.moveEnd.addEventListener(this.cameraMoveEnd)}getBounds(s){if(s){let h=180,r=-180,a=90,t=-180;s.forEach(function(i){const{x:d,y:o}=i;h=d<h?d:h,a=o<a?o:a,r=d>r?d:r,t=o>t?o:t});const e=r-h?r-h:1,n=t-a?t-a:1;return[h-e/10,a-n/10,r+e/10,t+n/10]}return[0,0,0,0]}createContainer(s){const h=document.createElement("div"),r=1e3,a=parseInt((1e3/(s[2]-s[0])*(s[3]-s[1])).toFixed(0));return h.setAttribute("style",`width:${r}px;height:${a}px;display:none;`),document.body.appendChild(h),{container:h,width:r,height:a}}}const q={__name:"heatMap",setup(f){const{viewer:s}=window;let h=null;const r=async()=>{const{res:t}=await F("/cesium-vue3-vite/json/heatMap.json"),{features:e}=t;console.log(t);let n=[];e!=null&&e.length&&(n=e.map(i=>({x:i.properties.lng-.05,y:i.properties.lat-.04,value:i.properties.num}))),h=new U(s,{zoomToLayer:!0,points:n,heatmapDataOptions:{max:1,min:0},heatmapOptions:{maxOpacity:1,minOpacity:0}})},a=()=>{h==null||h.remove()};return L(()=>{a()}),(t,e)=>{const n=B,i=E;return I(),S(i,null,{default:O(()=>[R(n,{type:"primary",onClick:r},{default:O(()=>e[0]||(e[0]=[M("\u5F00\u59CB")])),_:1}),R(n,{type:"primary",onClick:a},{default:O(()=>e[1]||(e[1]=[M("\u6E05\u9664")])),_:1})]),_:1})}}};export{q as default};
