import{_ as E}from"./OperateBox.2bc9a4e9.js";import{u as L,a as I,o as S,c as B,w as O,d as R,e as M}from"./index.f76e180b.js";import{E as F}from"./el-button.55669a7a.js";import{g as P}from"./api.42f836e8.js";import"./request.3e4b99dc.js";var D={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},G=function(){var s=function(a){this._coordinator={},this._data=[],this._radi=[],this._min=0,this._max=1,this._xField=a.xField||a.defaultXField,this._yField=a.yField||a.defaultYField,this._valueField=a.valueField||a.defaultValueField,a.radius&&(this._cfgRadius=a.radius)},d=D.defaultRadius;return s.prototype={_organiseData:function(r,a){var t=r[this._xField],e=r[this._yField],n=this._radi,i=this._data,o=this._max,h=this._min,m=r[this._valueField]||1,p=r.radius||this._cfgRadius||d;return i[t]||(i[t]=[],n[t]=[]),i[t][e]?i[t][e]+=m:(i[t][e]=m,n[t][e]=p),i[t][e]>o?(a?this.setDataMax(i[t][e]):this._max=i[t][e],!1):{x:t,y:e,value:m,radius:p,min:h,max:o}},_unOrganizeData:function(){var r=[],a=this._data,t=this._radi;for(var e in a)for(var n in a[e])r.push({x:e,y:n,radius:t[e][n],value:a[e][n]});return{min:this._min,max:this._max,data:r}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(arguments[0].length>0)for(var r=arguments[0],a=r.length;a--;)this.addData.call(this,r[a]);else{var t=this._organiseData(arguments[0],!0);t&&this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[t]})}return this},setData:function(r){var a=r.data,t=a.length;this._data=[],this._radi=[];for(var e=0;e<t;e++)this._organiseData(a[e],!1);return this._max=r.max,this._min=r.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(r){return this._max=r,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(r){return this._min=r,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(r){this._coordinator=r},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},s}(),T=function(){var s=function(t){var e=t.gradient||t.defaultGradient,n=document.createElement("canvas"),i=n.getContext("2d");n.width=256,n.height=1;var o=i.createLinearGradient(0,0,256,1);for(var h in e)o.addColorStop(h,e[h]);return i.fillStyle=o,i.fillRect(0,0,256,1),i.getImageData(0,0,256,1).data},d=function(t,e){var n=document.createElement("canvas"),i=n.getContext("2d"),o=t,h=t;if(n.width=n.height=t*2,e==1)i.beginPath(),i.arc(o,h,t,0,2*Math.PI,!1),i.fillStyle="rgba(0,0,0,1)",i.fill();else{var m=i.createRadialGradient(o,h,t*e,o,h,t);m.addColorStop(0,"rgba(0,0,0,1)"),m.addColorStop(1,"rgba(0,0,0,0)"),i.fillStyle=m,i.fillRect(0,0,2*t,2*t)}return n},r=function(h){for(var e=[],n=h.min,i=h.max,o=h.radi,h=h.data,m=Object.keys(h),p=m.length;p--;)for(var _=m[p],c=Object.keys(h[_]),g=c.length;g--;){var l=c[g],y=h[_][l],v=o[_][l];e.push({x:_,y:l,value:y,radius:v})}return{min:n,max:i,data:e}};function a(t){var e=t.container,n=this.shadowCanvas=document.createElement("canvas"),i=this.canvas=t.canvas||document.createElement("canvas");this._renderBoundaries=[1e4,1e4,0,0];var o=getComputedStyle(t.container)||{};i.className="heatmap-canvas",this._width=i.width=n.width=+o.width.replace(/px/,""),this._height=i.height=n.height=+o.height.replace(/px/,""),this.shadowCtx=n.getContext("2d"),this.ctx=i.getContext("2d"),i.style.cssText=n.style.cssText="position:absolute;left:0;top:0;",e.style.position="relative",e.appendChild(i),this._palette=s(t),this._templates={},this._setStyles(t)}return a.prototype={renderPartial:function(t){this._drawAlpha(t),this._colorize()},renderAll:function(t){this._clear(),this._drawAlpha(r(t)),this._colorize()},_updateGradient:function(t){this._palette=s(t)},updateConfig:function(t){t.gradient&&this._updateGradient(t),this._setStyles(t)},setDimensions:function(t,e){this._width=t,this._height=e,this.canvas.width=this.shadowCanvas.width=t,this.canvas.height=this.shadowCanvas.height=e},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(t){this._blur=t.blur==0?0:t.blur||t.defaultBlur,t.backgroundColor&&(this.canvas.style.backgroundColor=t.backgroundColor),this._opacity=(t.opacity||0)*255,this._maxOpacity=(t.maxOpacity||t.defaultMaxOpacity)*255,this._minOpacity=(t.minOpacity||t.defaultMinOpacity)*255,this._useGradientOpacity=!!t.useGradientOpacity},_drawAlpha:function(i){for(var e=this._min=i.min,n=this._max=i.max,i=i.data||[],o=i.length,h=1-this._blur;o--;){var m=i[o],p=m.x,_=m.y,c=m.radius,g=Math.min(m.value,n),l=p-c,y=_-c,v=this.shadowCtx,u;this._templates[c]?u=this._templates[c]:this._templates[c]=u=d(c,h),v.globalAlpha=(g-e)/(n-e),v.drawImage(u,l,y),l<this._renderBoundaries[0]&&(this._renderBoundaries[0]=l),y<this._renderBoundaries[1]&&(this._renderBoundaries[1]=y),l+2*c>this._renderBoundaries[2]&&(this._renderBoundaries[2]=l+2*c),y+2*c>this._renderBoundaries[3]&&(this._renderBoundaries[3]=y+2*c)}},_colorize:function(){var t=this._renderBoundaries[0],e=this._renderBoundaries[1],n=this._renderBoundaries[2]-t,i=this._renderBoundaries[3]-e,o=this._width,h=this._height,m=this._opacity,p=this._maxOpacity,_=this._minOpacity,c=this._useGradientOpacity;t<0&&(t=0),e<0&&(e=0),t+n>o&&(n=o-t),e+i>h&&(i=h-e);for(var g=this.shadowCtx.getImageData(t,e,n,i),l=g.data,y=l.length,v=this._palette,u=3;u<y;u+=4){var w=l[u],x=w*4;if(!!x){var C;m>0?C=m:w<p?w<_?C=_:C=w:C=p,l[u-3]=v[x],l[u-2]=v[x+1],l[u-1]=v[x+2],l[u]=c?v[x+3]:C}}Object.defineProperty(g,"data",{value:l,writable:!0,configurable:!0,enumerable:!0}),this.ctx.putImageData(g,t,e),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(t){var e,n=this.shadowCtx,i=n.getImageData(t.x,t.y,1,1),o=i.data[3],h=this._max,m=this._min;return e=Math.abs(h-m)*(o/255)>>0,e},getDataURL:function(){return this.canvas.toDataURL()}},a}(),A=function(){var s=!1;return D.defaultRenderer==="canvas2d"&&(s=T),s}(),b={merge:function(){for(var f={},s=arguments.length,d=0;d<s;d++){var r=arguments[d];for(var a in r)f[a]=r[a]}return f}},H=function(){var s=function(){function t(){this.cStore={}}return t.prototype={on:function(e,n,i){var o=this.cStore;o[e]||(o[e]=[]),o[e].push(function(h){return n.call(i,h)})},emit:function(e,n){var i=this.cStore;if(i[e])for(var o=i[e].length,h=0;h<o;h++){var m=i[e][h];m(n)}}},t}(),d=function(a){var t=a._renderer,e=a._coordinator,n=a._store;e.on("renderpartial",t.renderPartial,t),e.on("renderall",t.renderAll,t),e.on("extremachange",function(i){a._config.onExtremaChange&&a._config.onExtremaChange({min:i.min,max:i.max,gradient:a._config.gradient||a._config.defaultGradient})}),n.setCoordinator(e)};function r(){var a=this._config=b.merge(D,arguments[0]||{});if(this._coordinator=new s,a.plugin){var t=a.plugin;if(D.plugins[t]){var e=D.plugins[t];this._renderer=new e.renderer(a),this._store=new e.store(a)}else throw new Error("Plugin '"+t+"' not found. Maybe it was not registered.")}else this._renderer=new A(a),this._store=new G(a);d(this)}return r.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(a){return this._config=b.merge(this._config,a),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(a){return this._store.getValueAt?this._store.getValueAt(a):this._renderer.getValueAt?this._renderer.getValueAt(a):null}},r}(),U={create:function(f){return new H(f)},register:function(f,s){D.plugins[f]=s}};class z{constructor(s,d){var r,a,t;if(this.viewer=s,this.initOptions={...d},(r=this.initOptions)!=null&&r.points){const e=this.getBounds(this.initOptions.points);this.bounds=e;const{container:n,width:i,height:o}=this.createContainer(e);this.element=n;const h=[],m=[];for(let v in this.initOptions.points){const u=this.initOptions.points[v],w=(u.x-e[0])/(e[2]-e[0])*i,x=(e[3]-u.y)/(e[3]-e[1])*o,C={x:w,y:x,value:u.value};typeof u.value=="number"&&m.push(u.value),h.push(C)}let p=Math.min(...m),_=Math.max(...m);if((a=this.initOptions)!=null&&a.heatmapDataOptions){const{min:v,max:u}=this.initOptions.heatmapDataOptions;typeof v=="number"&&(p=v),typeof u=="number"&&(_=u)}this.heatmapDataOptions={min:p,max:_};const c={max:_,min:p,data:h},g={maxOpacity:.9,minOpacity:.1,gradient:{".3":"blue",".5":"green",".7":"yellow",".95":"red"}},l=this.initOptions.heatmapOptions?{...g,...this.initOptions.heatmapOptions}:g;(t=this.heatmapOptions)!=null&&t.radius&&(this.initRadius=this.heatmapOptions.radius),this.heatmapOptions={...l};const y={...l,container:n};this.heatmap=U.create(y),this.heatmap.setData(c),this.createLayer(),this.initOptions.noLisenerCamera||this.addLisener(),this.initOptions.zoomToLayer&&e&&this.viewer.camera.flyTo({destination:Cesium.Rectangle.fromDegrees(...e)})}}updateHeatMapMaxMin(s){const{min:d,max:r}=s;this.heatmap&&(typeof d=="number"&&(this.heatmap.setDataMin(d),this.heatmapDataOptions&&(this.heatmapDataOptions.min=d)),typeof r=="number"&&(this.heatmap.setDataMax(r),this.heatmapDataOptions&&(this.heatmapDataOptions.max=r))),this.updateLayer()}updateHeatmap(s){const{heatmapOptions:d}=this;this.heatmap.configure({...d,...s}),this.updateLayer()}updateRadius(s){var a;const{heatmapOptions:d}=this,r=this.heatmap.getData();if(r!=null&&r.data)for(let t in r.data){const e=r.data[t];e.radius=s}this.heatmap.setData(r),this.heatmapOptions={...d,radius:s},this.updateLayer(),(a=this.initOptions)!=null&&a.onRadiusChange&&this.initOptions.onRadiusChange(s)}remove(){this.element&&(document.body.removeChild(this.element),this.element=void 0,this.provider instanceof Cesium.ImageryLayer?(this.provider&&this.viewer.imageryLayers.remove(this.provider),this.createSingleTileImageryLayer()):this.provider instanceof Cesium.Primitive?this.viewer.scene.primitives.remove(this.provider):this.provider instanceof Cesium.Entity&&this.viewer.entities.remove(this.provider),this.cameraMoveEnd&&(this.viewer.camera.moveEnd.removeEventListener(this.cameraMoveEnd),this.cameraMoveEnd=void 0))}createLayer(){this.initOptions.renderType==="primitive"?this.createPrimitive():this.initOptions.renderType==="imagery"?this.createSingleTileImageryLayer():this.createEntity()}createPrimitive(){const s=this.heatmap.getDataURL();this.provider=this.viewer.scene.primitives.add(new Cesium.Primitive({geometryInstances:new Cesium.GeometryInstance({geometry:new Cesium.RectangleGeometry({rectangle:Cesium.Rectangle.fromDegrees(...this.bounds),vertexFormat:Cesium.EllipsoidSurfaceAppearance.VERTEX_FORMAT})}),appearance:new Cesium.EllipsoidSurfaceAppearance({aboveGround:!1}),show:!0})),this.provider&&(this.provider.appearance.material=new Cesium.Material({fabric:{type:"Image",uniforms:{image:s}}}))}createSingleTileImageryLayer(){const s=this.heatmap.getDataURL();this.provider=this.viewer.imageryLayers.addImageryProvider(new Cesium.SingleTileImageryProvider({url:s,rectangle:Cesium.Rectangle.fromDegrees(...this.bounds)}))}getImageMaterialProperty(){const s=this.heatmap.getDataURL();return new Cesium.ImageMaterialProperty({image:s})}createEntity(){this.provider=this.viewer.entities.add({show:!0,rectangle:{coordinates:Cesium.Rectangle.fromDegrees(...this.bounds),material:this.getImageMaterialProperty()}})}updateLayer(){const s=this.heatmap.getDataURL();this.provider instanceof Cesium.ImageryLayer?(this.provider&&this.viewer.imageryLayers.remove(this.provider),this.createSingleTileImageryLayer()):this.provider instanceof Cesium.Primitive?this.provider.appearance.material.uniforms.image=s:this.provider instanceof Cesium.Entity&&this.provider.rectangle&&(this.provider.rectangle.material=this.getImageMaterialProperty())}addLisener(){this.cameraMoveEnd=()=>{var a;if(this.heatmapOptions&&this.heatmap&&this.heatmapDataOptions){const t=this.viewer.camera.getMagnitude(),e=(a=this==null?void 0:this.initOptions)!=null&&a.cameraHeightDistance?this.initOptions.cameraHeightDistance:1e3;if(Math.abs(t-this.lastCameraHeight)>e){this.lastCameraHeight=t;{const n=parseInt((this.initRadius+(100-this.initRadius)*(t-6375e3)/3625e3).toFixed(0));n&&this.updateRadius(n)}}}},this.viewer.camera.moveEnd.addEventListener(this.cameraMoveEnd)}getBounds(s){if(s){let d=180,r=-180,a=90,t=-180;s.forEach(function(i){const{x:o,y:h}=i;d=o<d?o:d,a=h<a?h:a,r=o>r?o:r,t=h>t?h:t});const e=r-d?r-d:1,n=t-a?t-a:1;return[d-e/10,a-n/10,r+e/10,t+n/10]}return[0,0,0,0]}createContainer(s){const d=document.createElement("div"),r=1e3,a=parseInt((1e3/(s[2]-s[0])*(s[3]-s[1])).toFixed(0));return d.setAttribute("style",`width:${r}px;height:${a}px;display:none;`),document.body.appendChild(d),{container:d,width:r,height:a}}}const q={__name:"heatMap",setup(f){const s=L(),{viewer:d}=s.state;let r=null;const a=async()=>{const{res:e}=await P("/json/heatMap.json"),{features:n}=e;console.log(e);let i=[];n!=null&&n.length&&(i=n.map(o=>({x:o.properties.lng-.05,y:o.properties.lat-.04,value:o.properties.num}))),r=new z(d,{zoomToLayer:!0,points:i,heatmapDataOptions:{max:1,min:0},heatmapOptions:{maxOpacity:1,minOpacity:0}})},t=()=>{r==null||r.remove()};return I(()=>{t()}),(e,n)=>{const i=F,o=E;return S(),B(o,null,{default:O(()=>[R(i,{type:"primary",onClick:a},{default:O(()=>[M("\u5F00\u59CB")]),_:1}),R(i,{type:"primary",onClick:t},{default:O(()=>[M("\u6E05\u9664")]),_:1})]),_:1})}}};export{q as default};
